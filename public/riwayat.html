<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Riwayat Akses QR</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      h2 {
        text-align: center;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        border: 1px solid #aaa;
        padding: 10px;
        text-align: left;
      }
      th {
        background-color: #f3f3f3;
      }
      .btn-hapus,
      .btn-hapus-baris {
        padding: 6px 12px;
        background-color: #d9534f;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 5px;
        margin-top: 5px;
      }
      .btn-hapus:hover,
      .btn-hapus-baris:hover {
        background-color: #c9302c;
      }
    </style>
  </head>
  <body>
    <h2>Riwayat Akses QR</h2>

    <button class="btn-hapus" onclick="hapusSemua()">Hapus Semua Data</button>
    <button class="btn-hapus" onclick="hapusTerakhir(3)">
      Hapus 3 Hari Terakhir
    </button>
    <button class="btn-hapus" onclick="hapusTerakhir(7)">
      Hapus 1 Minggu Terakhir
    </button>
    <button class="btn-hapus" onclick="hapusTerakhir(14)">
      Hapus 2 Minggu Terakhir
    </button>

    <table>
      <thead>
        <tr>
          <th>Nama</th>
          <th>NIM</th>
          <th>Waktu</th>
          <th>Data Terhapus Pada</th>
          <th>Timer</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="tabelRiwayat">
        <!-- Data akan dimuat di sini -->
      </tbody>
    </table>

    <script>
      function formatTanggalHapus(waktuString) {
        const waktu = new Date(waktuString);
        if (isNaN(waktu)) return "-";
        waktu.setDate(waktu.getDate() + 30);
        return waktu;
      }

      function formatTimer(targetDate) {
        const now = new Date();
        const selisih = targetDate - now;

        if (selisih <= 0) return "Expired";

        const detik = Math.floor((selisih / 1000) % 60);
        const menit = Math.floor((selisih / 1000 / 60) % 60);
        const jam = Math.floor((selisih / (1000 * 60 * 60)) % 24);
        const hari = Math.floor(selisih / (1000 * 60 * 60 * 24));

        return `${hari}h ${jam}j ${menit}m ${detik}d`;
      }

      async function muatRiwayat() {
        try {
          const res = await fetch(
            "https://dbweb-690f4-default-rtdb.firebaseio.com/pengguna.json"
          );
          const data = await res.json();
          const tbody = document.getElementById("tabelRiwayat");
          tbody.innerHTML = "";

          if (!data) {
            tbody.innerHTML = "<tr><td colspan='6'>Tidak ada data</td></tr>";
            return;
          }

          Object.entries(data).forEach(([key, item]) => {
            const waktuFormatted = item.waktu || "-";
            const tanggalHapusObj = formatTanggalHapus(item.waktu);
            const tanggalHapus = tanggalHapusObj.toLocaleString("en-US");

            const tr = document.createElement("tr");

            tr.innerHTML = `
              <td>${item.nama || "-"}</td>
              <td>${item.nim || "-"}</td>
              <td>${waktuFormatted}</td>
              <td>${tanggalHapus}</td>
              <td class="timer" data-waktu="${tanggalHapusObj}">--</td>
              <td><button class="btn-hapus-baris" onclick="hapusBaris('${key}')">Hapus</button></td>
            `;

            tbody.appendChild(tr);
          });

          updateTimerSetiapDetik();
        } catch (err) {
          alert("Gagal memuat data riwayat");
          console.error(err);
        }
      }

      function updateTimerSetiapDetik() {
        setInterval(() => {
          const timerCells = document.querySelectorAll(".timer");
          timerCells.forEach((cell) => {
            const target = new Date(cell.dataset.waktu);
            cell.textContent = formatTimer(target);
          });
        }, 1000);
      }

      async function hapusSemua() {
        const konfirmasi = confirm("Yakin ingin menghapus SEMUA data?");
        if (!konfirmasi) return;

        await fetch(
          "https://dbweb-690f4-default-rtdb.firebaseio.com/pengguna.json",
          {
            method: "DELETE",
          }
        );

        alert("Semua data telah dihapus.");
        muatRiwayat();
      }

      async function hapusBaris(id) {
        const konfirmasi = confirm("Yakin ingin menghapus baris ini?");
        if (!konfirmasi) return;

        await fetch(
          `https://dbweb-690f4-default-rtdb.firebaseio.com/pengguna/${id}.json`,
          {
            method: "DELETE",
          }
        );

        muatRiwayat();
      }

      // Fungsi tambahan untuk menghapus data dalam n hari terakhir
      async function hapusTerakhir(jumlahHari) {
        const konfirmasi = confirm(
          `Yakin ingin menghapus data ${jumlahHari} hari terakhir?`
        );
        if (!konfirmasi) return;

        try {
          const res = await fetch(
            "https://dbweb-690f4-default-rtdb.firebaseio.com/pengguna.json"
          );
          const data = await res.json();
          if (!data) return;

          const batasWaktu = new Date();
          batasWaktu.setDate(batasWaktu.getDate() - jumlahHari);

          const promises = [];

          Object.entries(data).forEach(([key, item]) => {
            const waktu = new Date(item.waktu);
            if (!isNaN(waktu) && waktu >= batasWaktu) {
              const url = `https://dbweb-690f4-default-rtdb.firebaseio.com/pengguna/${key}.json`;
              promises.push(fetch(url, { method: "DELETE" }));
            }
          });

          await Promise.all(promises);
          alert(`Data ${jumlahHari} hari terakhir berhasil dihapus.`);
          muatRiwayat();
        } catch (err) {
          alert("Gagal menghapus data.");
          console.error(err);
        }
      }

      muatRiwayat();
    </script>
  </body>
</html>
