<!DOCTYPE html>
<html>
  <head>
    <title>Tambah Kolom dan Edit Data</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 1000px;
        margin: auto;
        padding: 20px;
      }
      input,
      button {
        padding: 10px;
        margin-top: 10px;
        width: 100%;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
      td input {
        width: 95%;
        padding: 4px;
      }
    </style>
  </head>
  <body>
    <h2>Tambah Kolom ke Tabel "users"</h2>

    <label for="namaKolom">Nama Kolom:</label>
    <input type="text" id="namaKolom" placeholder="Contoh: email" />

    <label for="tipeData">Tipe Data:</label>
    <input type="text" id="tipeData" placeholder="Contoh: VARCHAR(100)" />

    <button onclick="tambahKolom()">Tambah Kolom</button>
    <p id="hasil" style="margin-top: 10px; color: green"></p>

    <hr />

    <h3>Data dari Tabel "users"</h3>
    <button onclick="loadData()">🔄 Refresh Data</button>
    <table id="tabelData">
      <thead id="tabelHeader"></thead>
      <tbody id="tabelBody"></tbody>
    </table>

    <script>
      let kolomUtama = [];

      function tambahKolom() {
        const namaKolom = document.getElementById("namaKolom").value;
        const tipeData = document.getElementById("tipeData").value;

        fetch("/tambah-kolom", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ namaKolom, tipeData }),
        })
          .then((res) => res.json())
          .then((data) => {
            const hasil = document.getElementById("hasil");
            if (data.error) {
              hasil.style.color = "red";
              hasil.textContent =
                "❌ Error: " + (data.error.sqlMessage || data.error);
            } else {
              hasil.style.color = "green";
              hasil.textContent = "✅ " + data.message;
              loadData();
            }
          })
          .catch((err) => {
            document.getElementById("hasil").textContent =
              "❌ Gagal: " + err.message;
          });
      }

      function loadData() {
        fetch("/data")
          .then((res) => res.json())
          .then((data) => {
            const header = document.getElementById("tabelHeader");
            const body = document.getElementById("tabelBody");
            header.innerHTML = "";
            body.innerHTML = "";

            if (data.length === 0) {
              header.innerHTML = "<tr><th>Data kosong</th></tr>";
              return;
            }

            kolomUtama = Object.keys(data[0]);
            const headerRow = kolomUtama.map((k) => `<th>${k}</th>`).join("");
            header.innerHTML = `<tr>${headerRow}<th>Aksi</th></tr>`;

            data.forEach((row) => {
              let rowHTML = "";
              kolomUtama.forEach((k) => {
                rowHTML += `<td><input type="text" value="${
                  row[k] ?? ""
                }" data-id="${row.id}" data-kolom="${k}"></td>`;
              });
              rowHTML += `<td><button onclick="simpanEdit(${row.id})">Simpan</button></td>`;
              body.innerHTML += `<tr>${rowHTML}</tr>`;
            });
          })
          .catch((err) => {
            alert("Gagal memuat data: " + err.message);
          });
      }

      function simpanEdit(id) {
        const inputs = document.querySelectorAll(`input[data-id='${id}']`);
        inputs.forEach((input) => {
          const kolom = input.dataset.kolom;
          const nilaiBaru = input.value;

          fetch("/update-user", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id, kolom, nilaiBaru }),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.error) {
                alert(
                  `Gagal update kolom ${kolom}: ` +
                    (data.error.sqlMessage || data.error)
                );
              } else {
                console.log(`✅ ${kolom} berhasil diupdate`);
              }
            });
        });

        alert("✅ Data berhasil diperbarui");
        loadData(); // refresh tampilan
      }

      window.onload = loadData;
    </script>
  </body>
</html>
