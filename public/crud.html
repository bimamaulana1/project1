<!DOCTYPE html>
<html>
  <head>
    <title>Tambah Kolom, Edit, Hapus</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 1000px;
        margin: auto;
        padding: 20px;
      }
      input,
      button {
        padding: 8px;
        margin-top: 10px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 6px;
        text-align: left;
      }
      th {
        background-color: #f4f4f4;
      }
      td input[type="text"] {
        width: 100%;
      }
      .btn-hapus {
        background-color: #e74c3c;
        color: white;
        border: none;
        padding: 6px 10px;
        cursor: pointer;
      }
      .btn-simpan {
        background-color: #2ecc71;
        color: white;
        border: none;
        padding: 6px 10px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h2>Tambah Kolom ke Tabel "users"</h2>

    <label for="namaKolom">Nama Kolom:</label>
    <input type="text" id="namaKolom" placeholder="Contoh: email" />
    <label for="tipeData">Tipe Data:</label>
    <input type="text" id="tipeData" placeholder="Contoh: VARCHAR(100)" />
    <button onclick="tambahKolom()">Tambah Kolom</button>
    <p id="hasil" style="margin-top: 10px; color: green"></p>

    <hr />

    <h3>Data dari Tabel "users"</h3>
    <button onclick="loadData()">ðŸ”„ Refresh Data</button>
    <table id="tabelData">
      <thead id="tabelHeader"></thead>
      <tbody id="tabelBody"></tbody>
    </table>

    <script>
      let kolomUtama = [];

      function tambahKolom() {
        const namaKolom = document.getElementById("namaKolom").value;
        const tipeData = document.getElementById("tipeData").value;

        fetch("/tambah-kolom", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ namaKolom, tipeData }),
        })
          .then((res) => res.json())
          .then((data) => {
            const hasil = document.getElementById("hasil");
            if (data.error) {
              hasil.style.color = "red";
              hasil.textContent =
                "âŒ Error: " + (data.error.sqlMessage || data.error);
            } else {
              hasil.style.color = "green";
              hasil.textContent = "âœ… " + data.message;
              loadData();
            }
          });
      }

      function loadData() {
        fetch("/data")
          .then((res) => res.json())
          .then((data) => {
            const header = document.getElementById("tabelHeader");
            const body = document.getElementById("tabelBody");
            header.innerHTML = "";
            body.innerHTML = "";

            if (data.length === 0) {
              header.innerHTML = "<tr><th>Data kosong</th></tr>";
              return;
            }

            kolomUtama = Object.keys(data[0]);
            if (!kolomUtama.includes("aktif")) kolomUtama.push("aktif"); // tambahkan kolom aktif jika belum ada

            const headerRow =
              kolomUtama.map((k) => `<th>${k}</th>`).join("") + `<th>Aksi</th>`;
            header.innerHTML = `<tr>${headerRow}</tr>`;

            data.forEach((row) => {
              let rowHTML = "";
              kolomUtama.forEach((k) => {
                if (k === "aktif") {
                  const checked = row[k] == 1 ? "checked" : "";
                  rowHTML += `<td><input type="checkbox" data-id="${row.id}" data-kolom="aktif" onchange="ubahCheckbox(this)" ${checked}></td>`;
                } else {
                  rowHTML += `<td><input type="text" value="${
                    row[k] ?? ""
                  }" data-id="${row.id}" data-kolom="${k}"></td>`;
                }
              });

              rowHTML += `
              <td>
                <button class="btn-simpan" onclick="simpanEdit(${row.id})">Simpan</button>
                <button class="btn-hapus" onclick="hapusUser(${row.id})">Hapus</button>
              </td>
            `;

              body.innerHTML += `<tr>${rowHTML}</tr>`;
            });
          });
      }

      function simpanEdit(id) {
        const inputs = document.querySelectorAll(`input[data-id='${id}']`);
        inputs.forEach((input) => {
          const kolom = input.dataset.kolom;
          const nilaiBaru =
            input.type === "checkbox" ? (input.checked ? 1 : 0) : input.value;

          fetch("/update-user", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id, kolom, nilaiBaru }),
          });
        });

        alert("âœ… Data berhasil diperbarui");
        loadData();
      }

      function ubahCheckbox(checkbox) {
        const id = checkbox.dataset.id;
        const kolom = checkbox.dataset.kolom;
        const nilaiBaru = checkbox.checked ? 1 : 0;

        fetch("/update-user", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id, kolom, nilaiBaru }),
        });
      }

      function hapusUser(id) {
        if (!confirm("Yakin ingin menghapus data ini?")) return;

        fetch("/hapus-user", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id }),
        })
          .then((res) => res.json())
          .then((data) => {
            alert("âœ… Data berhasil dihapus");
            loadData();
          });
      }

      window.onload = loadData;
    </script>
  </body>
</html>
